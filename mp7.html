<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistem Pelayanan Penjualan v1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body{padding:20px}
    .small-input{width:100px}
    .pointer{cursor:pointer}
    .tab-pane{max-height:70vh;overflow:auto}
  </style>
</head>
<body>
  <h3>Sistem Pelayanan Penjualan v1 (HTML + JavaScript)</h3>
  <p>Single-file demo: CRUD untuk User, Supplier, Kategori, Item, Produk + Transaksi (Member / Umum) + Kredit & Laporan. Menyimpan data ke <code>localStorage</code>.</p>

  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users">Users</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#suppliers">Suppliers</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#categories">Categories</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#items">Items</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#products">Products</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#transactions">Transaksi</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#credits">Daftar Kredit</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports">Laporan</button></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- USERS -->
    <div class="tab-pane fade show active" id="users">
      <div class="d-flex justify-content-between mb-2">
        <h5>Users</h5>
        <button class="btn btn-primary" onclick="showUserForm()">Tambah User</button>
      </div>
      <table class="table table-sm table-striped" id="tblUsers">
        <thead><tr><th>ID</th><th>Nama</th><th>NIK</th><th>Photo</th><th>HP</th><th>Alamat</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SUPPLIERS -->
    <div class="tab-pane fade" id="suppliers">
      <div class="d-flex justify-content-between mb-2">
        <h5>Suppliers</h5>
        <button class="btn btn-primary" onclick="showSupplierForm()">Tambah Supplier</button>
      </div>
      <table class="table table-sm table-striped" id="tblSuppliers"><thead><tr><th>ID</th><th>Nama Perusahaan</th><th>HP</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- CATEGORIES -->
    <div class="tab-pane fade" id="categories">
      <div class="d-flex justify-content-between mb-2">
        <h5>Kategori</h5>
        <button class="btn btn-primary" onclick="showCategoryForm()">Tambah Kategori</button>
      </div>
      <table class="table table-sm table-striped" id="tblCategories"><thead><tr><th>ID</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ITEMS -->
    <div class="tab-pane fade" id="items">
      <div class="d-flex justify-content-between mb-2">
        <h5>Item</h5>
        <button class="btn btn-primary" onclick="showItemForm()">Tambah Item</button>
      </div>
      <table class="table table-sm table-striped" id="tblItems"><thead><tr><th>ID</th><th>Nama Item</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- PRODUCTS -->
    <div class="tab-pane fade" id="products">
      <div class="d-flex justify-content-between mb-2">
        <h5>Products</h5>
        <button class="btn btn-primary" onclick="showProductForm()">Tambah Produk</button>
      </div>
      <table class="table table-sm table-striped" id="tblProducts"><thead><tr><th>ID</th><th>Nama</th><th>Supplier</th><th>Kategori</th><th>Item</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- TRANSACTIONS -->
    <div class="tab-pane fade" id="transactions">
      <div class="d-flex justify-content-between mb-2">
        <h5>Transaksi</h5>
        <button class="btn btn-success" onclick="showTransactionForm()">Buat Transaksi Baru</button>
      </div>
      <table class="table table-sm table-striped" id="tblTransactions"><thead><tr><th>ID</th><th>Nama Pelanggan</th><th>Total</th><th>Bayar</th><th>Metode</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- CREDITS -->
    <div class="tab-pane fade" id="credits">
      <h5>Daftar Kredit / Cicilan</h5>
      <table class="table table-sm table-striped" id="tblCredits"><thead><tr><th>ID</th><th>Transaksi ID</th><th>Nama</th><th>Pokok</th><th>Tenor</th><th>Bunga/bulan</th><th>Angsuran/bln</th><th>Sisa</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- REPORTS -->
    <div class="tab-pane fade" id="reports">
      <h5>Laporan Singkat</h5>
      <div id="reportContent"></div>
    </div>
  </div>

  <!-- Modals / Forms -->
  <div class="modal" tabindex="-1" id="modalForm">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // ---------- Utilities & storage ----------
  const DB_KEYS = {
    users: 'sp_users', suppliers: 'sp_suppliers', categories: 'sp_categories', items: 'sp_items', products: 'sp_products', transactions: 'sp_transactions', credits: 'sp_credits'
  }
  function load(key){return JSON.parse(localStorage.getItem(key)||'[]')}
  function save(key,arr){localStorage.setItem(key,JSON.stringify(arr))}
  function uid(prefix='id'){return prefix+Date.now()+Math.floor(Math.random()*1000)}

  // ---------- Render tables ----------
  function refreshAll(){renderUsers();renderSuppliers();renderCategories();renderItems();renderProducts();renderTransactions();renderCredits();renderReport()}

  // USERS
  function renderUsers(){
    const rows = load(DB_KEYS.users).map(u=>`<tr><td>${u.id}</td><td>${u.nama}</td><td>${u.nik}</td><td>${u.photo?'<img src="'+u.photo+'" width=40>':''}</td><td>${u.hp}</td><td>${u.alamat}</td><td><button class="btn btn-sm btn-warning" onclick="editUser('${u.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Hapus</button></td></tr>`).join('')
    document.querySelector('#tblUsers tbody').innerHTML = rows || '<tr><td colspan=7 class="text-muted">Belum ada user</td></tr>'
  }
  function showUserForm(user){
    user = user || {id:'',nama:'',nik:'',photo:'',hp:'',alamat:''}
    const body = `
      <form id="formUser">
        <div class="row">
          <div class="col-md-6 mb-2"><label>Nama</label><input required class="form-control" name="nama" value="${user.nama}\"></div>
          <div class="col-md-6 mb-2"><label>NIK</label><input required class="form-control" name="nik" value="${user.nik}"></div>
          <div class="col-md-6 mb-2"><label>HP</label><input required class="form-control" name="hp" value="${user.hp}"></div>
          <div class="col-md-6 mb-2"><label>Alamat</label><input required class="form-control" name="alamat" value="${user.alamat}"></div>
          <div class="col-md-12 mb-2"><label>Photo (dataURL)</label><input class="form-control" name="photo" value="${user.photo}"></div>
        </div>
      </form>`
    showModal('Form User', body, `<button class="btn btn-primary" onclick="saveUser('${user.id || ''}')">Simpan</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`) 
  }
  function saveUser(id){
    const f = document.getElementById('formUser')
    if(!f.reportValidity()) return Swal.fire('Validasi','Lengkapi data user','warning')
    const data = Object.fromEntries(new FormData(f))
    const arr = load(DB_KEYS.users)
    if(id){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...data}; save(DB_KEYS.users,arr); Swal.fire('Sukses','User diupdate','success')} }
    else { const nid=uid('U'); arr.push({id:nid,...data}); save(DB_KEYS.users,arr); Swal.fire('Sukses','User ditambahkan','success') }
    bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); refreshAll()
  }
  function editUser(id){ const u=load(DB_KEYS.users).find(x=>x.id===id); showUserForm(u) }
  function deleteUser(id){ Swal.fire({title:'Hapus?',text:'Yakin hapus user?',showCancelButton:true}).then(r=>{ if(r.isConfirmed){ let arr=load(DB_KEYS.users); arr=arr.filter(x=>x.id!==id); save(DB_KEYS.users,arr); refreshAll(); Swal.fire('Terhapus','User dihapus','success') }}) }

  // SUPPLIERS
  function renderSuppliers(){ const rows = load(DB_KEYS.suppliers).map(s=>`<tr><td>${s.id}</td><td>${s.nama}</td><td>${s.hp}</td><td>${s.ket||''}</td><td><button class="btn btn-sm btn-warning" onclick="editSupplier('${s.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteSupplier('${s.id}')">Hapus</button></td></tr>`).join(''); document.querySelector('#tblSuppliers tbody').innerHTML = rows || '<tr><td colspan=5 class="text-muted">Belum ada supplier</td></tr>' }
  function showSupplierForm(s){ s = s || {id:'',nama:'',hp:'',ket:''}; const body=`<form id="formSupplier"><div class="row"><div class="col-md-6"><label>Nama Perusahaan</label><input required class="form-control" name="nama" value="${s.nama}"></div><div class="col-md-6"><label>HP</label><input required class="form-control" name="hp" value="${s.hp}"></div><div class="col-12"><label>Keterangan</label><input class="form-control" name="ket" value="${s.ket}"></div></div></form>`; showModal('Form Supplier',body,`<button class="btn btn-primary" onclick="saveSupplier('${s.id||''}')">Simpan</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)}
  function saveSupplier(id){ const f=document.getElementById('formSupplier'); if(!f.reportValidity()) return Swal.fire('Validasi','Lengkapi data supplier','warning'); const data=Object.fromEntries(new FormData(f)); const arr=load(DB_KEYS.suppliers); if(id){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...data}; save(DB_KEYS.suppliers,arr); Swal.fire('Sukses','Supplier diupdate','success')} } else { arr.push({id:uid('S'),...data}); save(DB_KEYS.suppliers,arr); Swal.fire('Sukses','Supplier ditambahkan','success')} bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); refreshAll() }
  function editSupplier(id){ showSupplierForm(load(DB_KEYS.suppliers).find(x=>x.id===id)) }
  function deleteSupplier(id){ Swal.fire({title:'Hapus?',showCancelButton:true}).then(r=>{ if(r.isConfirmed){ let arr=load(DB_KEYS.suppliers); arr=arr.filter(x=>x.id!==id); save(DB_KEYS.suppliers,arr); refreshAll(); Swal.fire('Terhapus','Supplier dihapus','success') }}) }

  // CATEGORIES
  function renderCategories(){ const rows = load(DB_KEYS.categories).map(c=>`<tr><td>${c.id}</td><td>${c.nama}</td><td><button class="btn btn-sm btn-warning" onclick="editCategory('${c.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteCategory('${c.id}')">Hapus</button></td></tr>`).join(''); document.querySelector('#tblCategories tbody').innerHTML = rows || '<tr><td colspan=3 class="text-muted">Belum ada kategori</td></tr>' }
  function showCategoryForm(c){ c = c || {id:'',nama:''}; const body=`<form id="formCategory"><label>Nama</label><input required class="form-control" name="nama" value="${c.nama}"></form>`; showModal('Form Kategori',body,`<button class="btn btn-primary" onclick="saveCategory('${c.id||''}')">Simpan</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)}
  function saveCategory(id){ const f=document.getElementById('formCategory'); if(!f.reportValidity()) return Swal.fire('Validasi','Lengkapi data kategori','warning'); const data=Object.fromEntries(new FormData(f)); const arr=load(DB_KEYS.categories); if(id){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...data}; save(DB_KEYS.categories,arr); Swal.fire('Sukses','Kategori diupdate','success')} } else { arr.push({id:uid('C'),...data}); save(DB_KEYS.categories,arr); Swal.fire('Sukses','Kategori ditambahkan','success')} bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); refreshAll() }
  function editCategory(id){ showCategoryForm(load(DB_KEYS.categories).find(x=>x.id===id)) }
  function deleteCategory(id){ Swal.fire({title:'Hapus?',showCancelButton:true}).then(r=>{ if(r.isConfirmed){ let arr=load(DB_KEYS.categories); arr=arr.filter(x=>x.id!==id); save(DB_KEYS.categories,arr); refreshAll(); Swal.fire('Terhapus','Kategori dihapus','success') }}) }

  // ITEMS
  function renderItems(){ const rows = load(DB_KEYS.items).map(i=>`<tr><td>${i.id}</td><td>${i.nama}</td><td><button class="btn btn-sm btn-warning" onclick="editItem('${i.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('${i.id}')">Hapus</button></td></tr>`).join(''); document.querySelector('#tblItems tbody').innerHTML = rows || '<tr><td colspan=3 class="text-muted">Belum ada item</td></tr>' }
  function showItemForm(it){ it = it || {id:'',nama:''}; const body=`<form id="formItem"><label>Nama Item</label><input required class="form-control" name="nama" value="${it.nama}"></form>`; showModal('Form Item',body,`<button class="btn btn-primary" onclick="saveItem('${it.id||''}')">Simpan</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)}
  function saveItem(id){ const f=document.getElementById('formItem'); if(!f.reportValidity()) return Swal.fire('Validasi','Lengkapi data item','warning'); const data=Object.fromEntries(new FormData(f)); const arr=load(DB_KEYS.items); if(id){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...data}; save(DB_KEYS.items,arr); Swal.fire('Sukses','Item diupdate','success')} } else { arr.push({id:uid('I'),...data}); save(DB_KEYS.items,arr); Swal.fire('Sukses','Item ditambahkan','success')} bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); refreshAll() }
  function editItem(id){ showItemForm(load(DB_KEYS.items).find(x=>x.id===id)) }
  function deleteItem(id){ Swal.fire({title:'Hapus?',showCancelButton:true}).then(r=>{ if(r.isConfirmed){ let arr=load(DB_KEYS.items); arr=arr.filter(x=>x.id!==id); save(DB_KEYS.items,arr); refreshAll(); Swal.fire('Terhapus','Item dihapus','success') }}) }

  // PRODUCTS
  function renderProducts(){ const products=load(DB_KEYS.products); const suppliers=load(DB_KEYS.suppliers); const categories=load(DB_KEYS.categories); const items=load(DB_KEYS.items);
    const rows = products.map(p=>`<tr><td>${p.id}</td><td>${p.nama}</td><td>${(suppliers.find(s=>s.id===p.supplier)||{}).nama||''}</td><td>${(categories.find(c=>c.id===p.category)||{}).nama||''}</td><td>${(items.find(it=>it.id===p.item)||{}).nama||''}</td><td>${p.stok}</td><td>${formatRp(p.harga)}</td><td><button class="btn btn-sm btn-warning" onclick="editProduct('${p.id}')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Hapus</button></td></tr>`).join('')
    document.querySelector('#tblProducts tbody').innerHTML = rows || '<tr><td colspan=8 class="text-muted">Belum ada produk</td></tr>' }
  function showProductForm(p){ p = p || {id:'',nama:'',supplier:'',category:'',item:'',stok:0,harga:0}; const suppliers=load(DB_KEYS.suppliers); const categories=load(DB_KEYS.categories); const items=load(DB_KEYS.items);
    const body=`<form id="formProduct"><div class="row"><div class="col-md-6 mb-2"><label>Nama Produk</label><input required class="form-control" name="nama" value="${p.nama}"></div><div class="col-md-6 mb-2"><label>Supplier</label><select required class="form-control" name="supplier">${["",...suppliers].map(s=>`<option value="${s.id||''}" ${s.id===p.supplier?'selected':''}>${s.nama||''}</option>`).join('')}</select></div><div class="col-md-6 mb-2"><label>Kategori</label><select required class="form-control" name="category">${["",...categories].map(c=>`<option value="${c.id||''}" ${c.id===p.category?'selected':''}>${c.nama||''}</option>`).join('')}</select></div><div class="col-md-6 mb-2"><label>Item</label><select required class="form-control" name="item">${["",...items].map(i=>`<option value="${i.id||''}" ${i.id===p.item?'selected':''}>${i.nama||''}</option>`).join('')}</select></div><div class="col-md-6 mb-2"><label>Stok</label><input required type="number" min="0" class="form-control" name="stok" value="${p.stok}"></div><div class="col-md-6 mb-2"><label>Harga</label><input required type="number" min="0" class="form-control" name="harga" value="${p.harga}"></div></div></form>`
    showModal('Form Produk',body,`<button class="btn btn-primary" onclick="saveProduct('${p.id||''}')">Simpan</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)
  }
  function saveProduct(id){ const f=document.getElementById('formProduct'); if(!f.reportValidity()) return Swal.fire('Validasi','Lengkapi data produk','warning'); const data=Object.fromEntries(new FormData(f)); data.stok = Number(data.stok); data.harga = Number(data.harga); const arr=load(DB_KEYS.products); if(id){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...data}; save(DB_KEYS.products,arr); Swal.fire('Sukses','Produk diupdate','success')} } else { arr.push({id:uid('P'),...data}); save(DB_KEYS.products,arr); Swal.fire('Sukses','Produk ditambahkan','success')} bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); refreshAll() }
  function editProduct(id){ showProductForm(load(DB_KEYS.products).find(x=>x.id===id)) }
  function deleteProduct(id){ Swal.fire({title:'Hapus?',showCancelButton:true}).then(r=>{ if(r.isConfirmed){ let arr=load(DB_KEYS.products); arr=arr.filter(x=>x.id!==id); save(DB_KEYS.products,arr); refreshAll(); Swal.fire('Terhapus','Produk dihapus','success') }}) }

  // TRANSACTIONS
  function renderTransactions(){ const arr=load(DB_KEYS.transactions); document.querySelector('#tblTransactions tbody').innerHTML = arr.map(t=>`<tr><td>${t.id}</td><td>${t.namaPel}</td><td>${formatRp(t.total)}</td><td>${formatRp(t.paid||0)}</td><td>${t.metode}</td><td>${t.status||''}</td><td>${actionButtonsTx(t)}</td></tr>`).join('') || '<tr><td colspan=7 class="text-muted">Belum ada transaksi</td></tr>' }
  function actionButtonsTx(t){ let s = `<button class="btn btn-sm btn-info" onclick="viewTx('${t.id}')">Detail</button> `; if(t.metode==='TF' && t.confirmation!=='confirmed') s += `<button class="btn btn-sm btn-success" onclick="confirmTf('${t.id}')">Konfirmasi TF</button> `; if(t.metode==='KREDIT') s += `<button class="btn btn-sm btn-primary" onclick="viewCreditByTx('${t.id}')">Lihat Cicilan</button>`; return s }

  function showTransactionForm(){
    const users=load(DB_KEYS.users); const products=load(DB_KEYS.products);
    if(products.length===0) return Swal.fire('Perhatian','Tambah produk dahulu','warning')
    const body = `
      <form id="formTx">
        <div class="row">
          <div class="col-md-4 mb-2">
            <label>Tipe Pelanggan</label>
            <select class="form-control" id="txType" name="txType" onchange="txTypeChange()"><option value="member">Member</option><option value="umum">Umum</option></select>
          </div>
          <div class="col-md-8 mb-2" id="memberArea">
            <label>Member</label>
            <select class="form-control" name="memberId">
              ${users.map(u=>`<option value="${u.id}">${u.nama} (${u.id})</option>`).join('')}
            </select>
          </div>
          <div class="col-md-12 mb-2" id="umumArea" style="display:none">
            <label>Nama Pelanggan (Umum)</label>
            <input class="form-control" name="umumNama">
          </div>

          <div class="col-md-12 mb-2">
            <label>Tambah Produk ke List</label>
            <div class="input-group mb-2">
              <select id="selProduct" class="form-control">${products.map(p=>`<option value="${p.id}" data-stok="${p.stok}" data-harga="${p.harga}">${p.nama} | Stok:${p.stok} | ${formatRp(p.harga)}</option>`).join('')}</select>
              <input type="number" id="qtyProduct" class="form-control" value="1" min="1">
              <button type="button" class="btn btn-outline-primary" onclick="addProductToCart()">Tambah</button>
            </div>
            <table class="table table-sm" id="cartTable"><thead><tr><th>Produk</th><th>Qty</th><th>Harga</th><th>Subtotal</th><th>Aksi</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="col-md-6 mb-2">
            <label>Diskon</label>
            <div class="input-group">
              <select id="diskonType" class="form-control" onchange="recalc()"><option value="off">Off</option><option value="percent">Persen (%)</option><option value="nominal">Rupiah (Rp)</option></select>
              <input type="number" id="diskonValue" class="form-control" value="0" min="0" onchange="recalc()">
            </div>
          </div>

          <div class="col-md-6 mb-2">
            <label>Metode Pembayaran</label>
            <select id="metodeBayar" class="form-control" onchange="metodeChange()"><option value="CASH">Cash</option><option value="TF">TF</option><option value="KREDIT">KREDIT</option></select>
          </div>

          <div class="col-md-6 mb-2" id="bayarArea">
            <label>Uang Bayar</label>
            <input type="number" id="uangBayar" class="form-control" value="0" onchange="recalc()">
          </div>

          <div class="col-md-6 mb-2" id="tenorArea" style="display:none">
            <label>Tenor (bulan)</label>
            <select id="tenor" class="form-control" onchange="recalc()"><option value="1">1</option><option value="3">3</option><option value="6">6</option><option value="9">9</option><option value="12">12</option></select>
          </div>

          <div class="col-md-12"><p id="summary"></p></div>
        </div>
      </form>
    `
    showModal('Form Transaksi', body, `<button class="btn btn-primary" onclick="saveTransaction()">Simpan Transaksi</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)
    cart = [];
    renderCart(); recalc();
  }

  let cart = []
  function addProductToCart(){ const sel = document.getElementById('selProduct'); const pid = sel.value; const stok = Number(sel.selectedOptions[0].dataset.stok); const harga = Number(sel.selectedOptions[0].dataset.harga); const qty = Number(document.getElementById('qtyProduct').value);
    if(qty<=0) return Swal.fire('Validasi','Qty minimal 1','warning')
    const prod = load(DB_KEYS.products).find(p=>p.id===pid);
    if(!prod) return Swal.fire('Error','Produk tidak ditemukan','error')
    if(qty>prod.stok) return Swal.fire('Stok','Qty melebihi stok','warning')
    const exist = cart.find(c=>c.id===pid)
    if(exist){ exist.qty+=qty } else { cart.push({id:pid,nama:prod.nama,qty,stok:prod.stok,harga:prod.harga}) }
    renderCart(); recalc()
  }
  function renderCart(){ const rows = cart.map(c=>`<tr><td>${c.nama}</td><td>${c.qty}</td><td>${formatRp(c.harga)}</td><td>${formatRp(c.qty*c.harga)}</td><td><button class="btn btn-sm btn-danger" onclick="removeCart('${c.id}')">Hapus</button></td></tr>`).join('')
    document.querySelector('#cartTable tbody').innerHTML = rows || '<tr><td colspan=5 class="text-muted">Keranjang kosong</td></tr>'
  }
  function removeCart(id){ cart = cart.filter(c=>c.id!==id); renderCart(); recalc() }

  function txTypeChange(){ const t=document.getElementById('txType').value; document.getElementById('memberArea').style.display = t==='member'?'block':'none'; document.getElementById('umumArea').style.display = t==='umum'?'block':'none' }
  function metodeChange(){ const m=document.getElementById('metodeBayar').value; document.getElementById('tenorArea').style.display = m==='KREDIT'?'block':'none'; document.getElementById('bayarArea').style.display = m==='TF' || m==='CASH' ? 'block' : 'block'; recalc() }

  function recalc(){
    const subtotal = cart.reduce((s,c)=>s + c.qty*c.harga,0)
    const diskonType = document.getElementById('diskonType')?.value || 'off'
    const diskonVal = Number(document.getElementById('diskonValue')?.value || 0)
    let diskonAmt = 0
    if(diskonType==='percent') diskonAmt = subtotal * (diskonVal/100)
    else if(diskonType==='nominal') diskonAmt = diskonVal
    const afterDisc = Math.max(0, subtotal - diskonAmt)
    const adminFee = afterDisc * 0.15 // 15% admin
    let total = afterDisc + adminFee
    const metode = document.getElementById('metodeBayar')?.value || 'CASH'
    const tenor = Number(document.getElementById('tenor')?.value || 1)
    const monthlyRate = 0.042 // 4.2% per bulan
    let monthlyPayment = 0
    if(metode==='KREDIT' && tenor>0){ // annuity formula
      const r = monthlyRate
      const P = total
      monthlyPayment = P * (r * Math.pow(1+r, tenor)) / (Math.pow(1+r, tenor) - 1)
    }
    const bayar = Number(document.getElementById('uangBayar')?.value || 0)
    const status = metode==='CASH' ? (bayar>=total ? 'LUNAS' : 'BELUM LUNAS') : (metode==='TF' ? (bayar>=total ? 'MENUNGGU_CONFIRM' : 'MENUNGGU_TF') : 'KREDIT')
    document.getElementById('summary').innerHTML = `Subtotal: ${formatRp(subtotal)}<br>Diskon: ${formatRp(diskonAmt)}<br>After Diskon: ${formatRp(afterDisc)}<br>Admin (15%): ${formatRp(adminFee)}<br><strong>Total: ${formatRp(total)}</strong><br>Metode: ${metode} ${metode==='KREDIT' ? '<br>Tenor: '+tenor+' bulan<br>Angsuran/bln: '+formatRp(monthlyPayment) : ''}<br>Uang Bayar: ${formatRp(bayar)}<br>Status saat ini: ${status}`
    return {subtotal, diskonAmt, afterDisc, adminFee, total, monthlyPayment, status}
  }

  function saveTransaction(){
    if(cart.length===0) return Swal.fire('Validasi','Keranjang kosong','warning')
    const form = document.getElementById('formTx')
    const txType = document.getElementById('txType').value
    let namaPel=''
    if(txType==='member'){ const mid = form.memberId.value; const u = load(DB_KEYS.users).find(x=>x.id===mid); if(!u) return Swal.fire('Validasi','Member tidak ditemukan','warning'); namaPel = `${u.nama} (${u.id})` }
    else { namaPel = form.umumNama.value || ''; if(!namaPel) return Swal.fire('Validasi','Isi nama pelanggan umum','warning') }

    const calc = recalc()
    const paid = Number(document.getElementById('uangBayar').value||0)
    const metode = document.getElementById('metodeBayar').value
    const tenor = Number(document.getElementById('tenor')?.value || 1)

    // jika cash namun bayar < total => arahkan ke kredit
    if(metode==='CASH' && paid < calc.total){
      return Swal.fire({title:'Pembayaran kurang',text:'Bayar kurang untuk CASH. Apakah ingin konversi ke KREDIT?',showCancelButton:true,confirmButtonText:'Konversi ke KREDIT'}).then(res=>{ if(res.isConfirmed){ document.getElementById('metodeBayar').value='KREDIT'; metodeChange(); recalc(); } })
    }

    const tx = { id: uid('TX'), namaPel, items: cart.map(c=>({id:c.id,nama:c.nama,qty:c.qty,harga:c.harga})), subtotal: calc.subtotal, diskon: calc.diskonAmt, admin: calc.adminFee, total: calc.total, paid, metode, tenor, status: calc.status, createdAt: new Date().toISOString() }
    const txArr = load(DB_KEYS.transactions); txArr.push(tx); save(DB_KEYS.transactions, txArr)

    // reduce stok jika bayar dilakukan (for simplicity always reduce stok for now)
    const products = load(DB_KEYS.products)
    tx.items.forEach(it=>{ const p = products.find(x=>x.id===it.id); if(p){ p.stok = Number(p.stok) - Number(it.qty); if(p.stok<0) p.stok=0 } })
    save(DB_KEYS.products, products)

    // jika metode kredit -> buat entry kredit
    if(metode==='KREDIT'){
      createCreditForTransaction(tx)
    }

    // jika TF -> mark confirmation as pending
    if(metode==='TF') tx.confirmation = paid>=tx.total ? 'confirmed' : 'pending'

    save(DB_KEYS.transactions, load(DB_KEYS.transactions))
    bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); Swal.fire('Sukses','Transaksi disimpan','success'); refreshAll()
  }

  // CREDITS / CICILAN
  function createCreditForTransaction(tx){ const credits = load(DB_KEYS.credits); const P = tx.total; const r = 0.042; const n = Number(tx.tenor || 1); let monthly = 0; if(n>0){ monthly = P * (r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1) } const c = { id: uid('K'), txId: tx.id, nama: tx.namaPel, pokok: P, tenor: n, bungaPerBulan: r, angsuranPerBulan: monthly, sisa: P, paidHistory: [] } credits.push(c); save(DB_KEYS.credits, credits); }

  function renderCredits(){ const arr = load(DB_KEYS.credits); document.querySelector('#tblCredits tbody').innerHTML = arr.map(c=>`<tr><td>${c.id}</td><td>${c.txId}</td><td>${c.nama}</td><td>${formatRp(c.pokok)}</td><td>${c.tenor}</td><td>${(c.bungaPerBulan*100).toFixed(2)}%</td><td>${formatRp(c.angsuranPerBulan)}</td><td>${formatRp(c.sisa)}</td><td><button class="btn btn-sm btn-info" onclick="detailCredit('${c.id}')">Detail</button> <button class="btn btn-sm btn-success" onclick="bayarCicilan('${c.id}')">Bayar Cicilan</button></td></tr>`).join('') || '<tr><td colspan=9 class="text-muted">Belum ada kredit</td></tr>' }

  function viewCreditByTx(txId){ const c = load(DB_KEYS.credits).find(x=>x.txId===txId); if(!c) return Swal.fire('Info','Tidak ada kredit untuk transaksi ini','info'); detailCredit(c.id) }

  function detailCredit(id){ const c = load(DB_KEYS.credits).find(x=>x.id===id); if(!c) return Swal.fire('Error','Kredit tidak ditemukan','error'); const body = `<p>ID: ${c.id}<br>Transaksi: ${c.txId}<br>Nama: ${c.nama}<br>Pokok: ${formatRp(c.pokok)}<br>Tenor: ${c.tenor} bulan<br>Angsuran/bln: ${formatRp(c.angsuranPerBulan)}<br>Sisa: ${formatRp(c.sisa)}</p><h6>Riwayat Pembayaran</h6><ul>${(c.paidHistory||[]).map(ph=>`<li>${ph.tanggal} - ${formatRp(ph.jumlah)}</li>`).join('') || '<li class="text-muted">Belum ada pembayaran</li>'}</ul>`; showModal('Detail Kredit', body, `<button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>`) }

  function bayarCicilan(id){ const c=load(DB_KEYS.credits).find(x=>x.id===id); if(!c) return Swal.fire('Error','Kredit tidak ditemukan','error'); const body = `<form id="formBayarCicilan"><label>Jumlah Bayar (angsuran):</label><input required type="number" min="1" class="form-control" name="jml" value="${Math.ceil(c.angsuranPerBulan)}"></form>`; showModal('Bayar Cicilan', body, `<button class="btn btn-primary" onclick="confirmBayarCicilan('${id}')">Bayar</button> <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>`)
  }
  function confirmBayarCicilan(id){ const f=document.getElementById('formBayarCicilan'); if(!f.reportValidity()) return Swal.fire('Validasi','Masukkan jumlah pembayaran','warning'); const jml = Number(new FormData(f).get('jml')); const credits=load(DB_KEYS.credits); const i = credits.findIndex(x=>x.id===id); if(i===-1) return Swal.fire('Error','Kredit tidak ditemukan','error'); credits[i].sisa = Math.max(0, credits[i].sisa - jml); credits[i].paidHistory = credits[i].paidHistory || []; credits[i].paidHistory.push({tanggal:new Date().toLocaleString(), jumlah:jml}); save(DB_KEYS.credits, credits); bootstrap.Modal.getInstance(document.getElementById('modalForm')).hide(); Swal.fire('Sukses','Pembayaran cicilan tercatat','success'); refreshAll() }

  // TF Confirmation
  function confirmTf(txId){ const txs = load(DB_KEYS.transactions); const i = txs.findIndex(t=>t.id===txId); if(i===-1) return Swal.fire('Error','Transaksi tidak ditemukan','error'); txs[i].confirmation='confirmed'; txs[i].status='LUNAS'; save(DB_KEYS.transactions, txs); Swal.fire('Sukses','TF dikonfirmasi','success'); refreshAll() }

  function viewTx(txId){ const t = load(DB_KEYS.transactions).find(x=>x.id===txId); if(!t) return Swal.fire('Error','Transaksi tidak ditemukan','error'); const itemsHtml = t.items.map(it=>`<li>${it.nama} x ${it.qty} @ ${formatRp(it.harga)} = ${formatRp(it.qty*it.harga)}</li>`).join(''); const body = `<p>ID: ${t.id}<br>Nama Pel: ${t.namaPel}<br>Tanggal: ${t.createdAt}<br>Metode: ${t.metode}<br>Status: ${t.status||''}<br>Total: ${formatRp(t.total)}<br>Paid: ${formatRp(t.paid||0)}</p><h6>Items</h6><ul>${itemsHtml}</ul>`; showModal('Detail Transaksi', body, `<button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>`) }

  // REPORT
  function renderReport(){ const products = load(DB_KEYS.products); const txs = load(DB_KEYS.transactions); const credits = load(DB_KEYS.credits);
    const totalSales = txs.reduce((s,t)=>s + (t.total||0),0)
    const totalPaid = txs.reduce((s,t)=>s + (t.paid||0),0)
    const stockAlert = products.filter(p=>p.stok<=2)
    const html = `<p>Total Transaksi: ${txs.length}<br>Total Penjualan (nilai): ${formatRp(totalSales)}<br>Total Pembayaran Diterima: ${formatRp(totalPaid)}<br>Jumlah Kredit Aktif: ${credits.length}</p><h6>Produk stock rendah (<=2)</h6><ul>${stockAlert.map(p=>`<li>${p.nama} - Stok: ${p.stok}</li>`).join('') || '<li class="text-muted">Tidak ada</li>'}</ul>`
    document.getElementById('reportContent').innerHTML = html }

  // Helpers
  function showModal(title, body, footer){ document.getElementById('modalTitle').innerText = title; document.getElementById('modalBody').innerHTML = body; document.getElementById('modalFooter').innerHTML = footer; const m = new bootstrap.Modal(document.getElementById('modalForm')); m.show(); }
  function formatRp(v){ return 'Rp '+Number(v).toLocaleString('id-ID') }

  // Init sample data if empty (for demo)
  if(load(DB_KEYS.products).length===0 && load(DB_KEYS.users).length===0){
    save(DB_KEYS.users,[{id:'U1',nama:'Budi',nik:'1234567890',photo:'',hp:'081234',alamat:'Jakarta'},{id:'U2',nama:'Siti',nik:'9876543210',photo:'',hp:'081298',alamat:'Bandung'}])
    save(DB_KEYS.suppliers,[{id:'S1',nama:'PT Sukses',hp:'081100',ket:'Distributor'}])
    save(DB_KEYS.categories,[{id:'C1',nama:'Elektronik'}])
    save(DB_KEYS.items,[{id:'I1',nama:'HP'}])
    save(DB_KEYS.products,[{id:'P1',nama:'Infinix Hot',supplier:'S1',category:'C1',item:'I1',stok:10,harga:1500000}])
  }

  // initial render
  refreshAll()
  </script>
</body>
</html>
