<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sistem Pelayanan Penjualan (Single File)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2d9d6f3b9.js" crossorigin="anonymous"></script>
  <style>
    body{padding:20px}
    .pointer{cursor:pointer}
    .small-img{width:40px;height:40px;object-fit:cover;border-radius:4px}
    .tab-card{padding:15px;border-radius:8px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h2 class="mb-3">Sistem Pelayanan Penjualan (HTML + JavaScript)</h2>
  <p class="text-muted">CRUD sederhana + Transaksi (Member/Umum) + Pembayaran (Cash/TF/Kredit). Data disimpan di <code>localStorage</code>.</p>

  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-users">Users</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-suppliers">Suppliers</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-cats">Kategori</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-items">Item</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-products">Produk</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-trans">Transaksi</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-reports">Laporan</a></li>
  </ul>

  <div class="tab-content">
    <!-- USERS -->
    <div class="tab-pane fade show active" id="tab-users">
      <div class="tab-card">
        <h5>Manajemen User</h5>
        <form id="formUser" class="row g-2 align-items-end">
          <input type="hidden" id="userIndex">
          <div class="col-md-2"><label class="form-label">ID</label><input class="form-control" id="userId" required></div>
          <div class="col-md-3"><label class="form-label">Nama</label><input class="form-control" id="userName" required></div>
          <div class="col-md-2"><label class="form-label">NIK</label><input class="form-control" id="userNIK"></div>
          <div class="col-md-2"><label class="form-label">HP</label><input class="form-control" id="userHP"></div>
          <div class="col-md-2"><label class="form-label">Photo URL</label><input class="form-control" id="userPhoto"></div>
          <div class="col-md-12"><label class="form-label">Alamat</label><input class="form-control" id="userAlamat"></div>
          <div class="col-md-12 text-end mt-2">
            <button class="btn btn-primary" type="submit">Simpan</button>
            <button class="btn btn-secondary" type="button" id="resetUser">Reset</button>
          </div>
        </form>
        <hr>
        <div class="table-responsive">
          <table class="table table-striped table-sm" id="tableUsers"><thead><tr><th>Photo</th><th>ID</th><th>Nama</th><th>NIK</th><th>HP</th><th>Alamat</th><th>Aksi</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- SUPPLIERS -->
    <div class="tab-pane fade" id="tab-suppliers">
      <div class="tab-card">
        <h5>Manajemen Supplier</h5>
        <form id="formSupplier" class="row g-2 align-items-end">
          <input type="hidden" id="supplierIndex">
          <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" id="supplierId" required></div>
          <div class="col-md-4"><label class="form-label">Nama Perusahaan</label><input class="form-control" id="supplierName" required></div>
          <div class="col-md-3"><label class="form-label">HP</label><input class="form-control" id="supplierHP"></div>
          <div class="col-md-12"><label class="form-label">Keterangan</label><input class="form-control" id="supplierKeterangan"></div>
          <div class="col-md-12 text-end mt-2"><button class="btn btn-primary" type="submit">Simpan</button><button class="btn btn-secondary" type="button" id="resetSupplier">Reset</button></div>
        </form>
        <hr>
        <table class="table table-striped table-sm" id="tableSuppliers"><thead><tr><th>ID</th><th>Nama</th><th>HP</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- CATEGORIES -->
    <div class="tab-pane fade" id="tab-cats">
      <div class="tab-card">
        <h5>Manajemen Kategori</h5>
        <form id="formCat" class="row g-2 align-items-end">
          <input type="hidden" id="catIndex">
          <div class="col-md-4"><label class="form-label">ID</label><input class="form-control" id="catId" required></div>
          <div class="col-md-6"><label class="form-label">Nama</label><input class="form-control" id="catName" required></div>
          <div class="col-md-12 text-end mt-2"><button class="btn btn-primary" type="submit">Simpan</button><button class="btn btn-secondary" type="button" id="resetCat">Reset</button></div>
        </form>
        <hr>
        <table class="table table-striped table-sm" id="tableCats"><thead><tr><th>ID</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- ITEMS -->
    <div class="tab-pane fade" id="tab-items">
      <div class="tab-card">
        <h5>Manajemen Item</h5>
        <form id="formItem" class="row g-2 align-items-end">
          <input type="hidden" id="itemIndex">
          <div class="col-md-4"><label class="form-label">ID</label><input class="form-control" id="itemId" required></div>
          <div class="col-md-6"><label class="form-label">Nama Item</label><input class="form-control" id="itemName" required></div>
          <div class="col-md-12 text-end mt-2"><button class="btn btn-primary" type="submit">Simpan</button><button class="btn btn-secondary" type="button" id="resetItem">Reset</button></div>
        </form>
        <hr>
        <table class="table table-striped table-sm" id="tableItems"><thead><tr><th>ID</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div class="tab-pane fade" id="tab-products">
      <div class="tab-card">
        <h5>Manajemen Produk</h5>
        <form id="formProduct" class="row g-2 align-items-end">
          <input type="hidden" id="prodIndex">
          <div class="col-md-2"><label class="form-label">ID</label><input class="form-control" id="prodId" required></div>
          <div class="col-md-3"><label class="form-label">Nama Produk</label><input class="form-control" id="prodName" required></div>
          <div class="col-md-3"><label class="form-label">Supplier</label><select class="form-select" id="prodSupplier"></select></div>
          <div class="col-md-2"><label class="form-label">Kategori</label><select class="form-select" id="prodCat"></select></div>
          <div class="col-md-2"><label class="form-label">Item</label><select class="form-select" id="prodItem"></select></div>
          <div class="col-md-2"><label class="form-label">Stok</label><input class="form-control" id="prodStock" type="number" min="0" value="0"></div>
          <div class="col-md-3"><label class="form-label">Harga (Rp)</label><input class="form-control" id="prodPrice" type="number" min="0" value="0"></div>
          <div class="col-md-12 text-end mt-2"><button class="btn btn-primary" type="submit">Simpan</button><button class="btn btn-secondary" type="button" id="resetProd">Reset</button></div>
        </form>
        <hr>
        <div class="table-responsive"><table class="table table-striped table-sm" id="tableProducts"><thead><tr><th>ID</th><th>Nama</th><th>Supplier</th><th>Kategori</th><th>Item</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="tab-pane fade" id="tab-trans">
      <div class="tab-card">
        <h5>Transaksi Penjualan</h5>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-2">
              <label class="form-label">Tipe Transaksi</label>
              <select class="form-select" id="transType"><option value="umum">Umum</option><option value="member">Member</option></select>
            </div>
            <div id="memberBlock" class="mb-2" style="display:none">
              <label class="form-label">Pilih Member</label>
              <select class="form-select" id="selectMember"><option value="">--Pilih--</option></select>
            </div>
            <div id="umumBlock" class="mb-2" style="display:block">
              <label class="form-label">Nama Pelanggan (Umum)</label>
              <input class="form-control" id="umumName">
            </div>
            <hr>
            <label class="form-label">Tambah Produk ke Keranjang</label>
            <div class="input-group mb-2">
              <select class="form-select" id="selectProduct"><option value="">--Pilih Produk--</option></select>
              <input class="form-control" id="cartQty" type="number" value="1" min="1" style="max-width:100px">
              <button class="btn btn-success" id="addToCart">Tambah</button>
            </div>

            <div class="mb-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="discountToggle">
                <label class="form-check-label" for="discountToggle">Gunakan Diskon</label>
              </div>
              <div id="discountBox" style="display:none" class="mt-2">
                <select class="form-select mb-2" id="discountType"><option value="percent">Persen (%)</option><option value="rupiah">Rupiah (Rp)</option></select>
                <input class="form-control" id="discountValue" placeholder="Masukkan nilai diskon">
              </div>
            </div>

            <hr>
            <h6>Ringkasan</h6>
            <div id="cartList"></div>
            <div class="mt-2"><strong>Subtotal:</strong> Rp <span id="subTotal">0</span></div>
            <div class="mt-1"><strong>Diskon:</strong> Rp <span id="diskonRp">0</span></div>
            <div class="mt-1"><strong>Biaya Admin (15% produk):</strong> Rp <span id="adminFee">0</span></div>
            <div class="mt-1"><strong>Total Pembayaran:</strong> Rp <span id="totalBayar">0</span></div>

          </div>
          <div class="col-md-6">
            <h6>Pembayaran</h6>
            <div class="mb-2"><label class="form-label">Uang Muka (DP)</label><input class="form-control" id="downPayment" type="number" min="0" value="0"></div>
            <div class="mb-2"><label class="form-label">Metode Pembayaran</label><select class="form-select" id="payMethod"><option value="cash">Cash</option><option value="tf">Transfer</option><option value="kredit">Kredit</option></select></div>
            <div id="tfBlock" style="display:none" class="mb-2"><label class="form-label">Bukti Transfer (URL)</label><input class="form-control" id="tfProof"></div>
            <div id="kreditBlock" style="display:none">
              <label class="form-label">Tenor Kredit</label>
              <select class="form-select mb-2" id="tenor"><option value="1">1 bulan</option><option value="3">3 bulan</option><option value="6">6 bulan</option><option value="9">9 bulan</option><option value="12">12 bulan</option></select>
              <div class="small text-muted">Bunga kredit: 4.20% / bulan</div>
            </div>
            <div class="mt-3 text-end">
              <button class="btn btn-primary" id="finishTrans">Simpan Transaksi</button>
            </div>
          </div>
        </div>
        <hr>
        <h6>Daftar Transaksi</h6>
        <div class="table-responsive"><table class="table table-sm table-striped" id="tableTrans"><thead><tr><th>ID</th><th>Pelanggan</th><th>Total</th><th>DP</th><th>Metode</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <!-- REPORTS -->
    <div class="tab-pane fade" id="tab-reports">
      <div class="tab-card">
        <h5>Laporan</h5>
        <div id="reportSummary"></div>
        <hr>
        <h6>Transaksi Lengkap</h6>
        <div class="table-responsive"><table class="table table-sm table-striped" id="reportTrans"><thead><tr><th>ID</th><th>Tanggal</th><th>Pelanggan</th><th>Produk</th><th>Total</th><th>Metode</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ======= STORAGE KEYS & INIT =======
const KEY = {
  users:'sp_users', suppliers:'sp_suppliers', cats:'sp_cats', items:'sp_items', prods:'sp_prods', trans:'sp_trans', credits:'sp_credits'
}
function load(key){return JSON.parse(localStorage.getItem(key) || '[]')}
function save(key,arr){localStorage.setItem(key, JSON.stringify(arr))}

// initial arrays
let users = load(KEY.users)
let suppliers = load(KEY.suppliers)
let cats = load(KEY.cats)
let items = load(KEY.items)
let prods = load(KEY.prods)
let trans = load(KEY.trans)
let credits = load(KEY.credits)

// ======= HELPERS =======
function formatRupiah(v){v = Number(v)||0; return v.toLocaleString('id-ID')}
function findIndexById(arr,id){return arr.findIndex(x=>x.id==id)}

// ======= USERS CRUD =======
const formUser = document.getElementById('formUser')
function renderUsers(){
  const tbody = document.querySelector('#tableUsers tbody'); tbody.innerHTML=''
  users.forEach((u,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td><img src="${u.photo||'https://via.placeholder.com/40'}" class="small-img"></td><td>${u.id}</td><td>${u.name}</td><td>${u.nik||''}</td><td>${u.hp||''}</td><td>${u.alamat||''}</td><td><button class='btn btn-sm btn-warning me-1' onclick="editUser(${i})">Edit</button><button class='btn btn-sm btn-danger' onclick="deleteUser(${i})">Hapus</button></td>`
    tbody.appendChild(tr)
  })
}
formUser.addEventListener('submit',e=>{
  e.preventDefault();
  const i = document.getElementById('userIndex').value
  const data = {id:document.getElementById('userId').value.trim(), name:document.getElementById('userName').value.trim(), nik:document.getElementById('userNIK').value.trim(), hp:document.getElementById('userHP').value.trim(), alamat:document.getElementById('userAlamat').value.trim(), photo:document.getElementById('userPhoto').value.trim()}
  if(!data.id||!data.name){alert('ID dan Nama wajib');return}
  if(i===''){ if(findIndexById(users,data.id)!==-1){alert('ID user sudah ada'); return} users.push(data) } else { users[i]=data }
  save(KEY.users,users); renderUsers(); resetUserForm(); populateMemberSelect();
})
function editUser(i){ const u=users[i]; document.getElementById('userIndex').value=i; document.getElementById('userId').value=u.id; document.getElementById('userName').value=u.name; document.getElementById('userNIK').value=u.nik; document.getElementById('userHP').value=u.hp; document.getElementById('userPhoto').value=u.photo; document.getElementById('userAlamat').value=u.alamat }
function deleteUser(i){ if(confirm('Hapus user?')){ users.splice(i,1); save(KEY.users,users); renderUsers(); populateMemberSelect() }}
document.getElementById('resetUser').addEventListener('click',resetUserForm)
function resetUserForm(){ document.getElementById('userIndex').value=''; formUser.reset() }

// ======= SUPPLIERS CRUD =======
const formSupplier = document.getElementById('formSupplier')
function renderSuppliers(){ const tbody = document.querySelector('#tableSuppliers tbody'); tbody.innerHTML=''; suppliers.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.id}</td><td>${s.name}</td><td>${s.hp||''}</td><td>${s.ket||''}</td><td><button class='btn btn-sm btn-warning me-1' onclick="editSupplier(${i})">Edit</button><button class='btn btn-sm btn-danger' onclick="deleteSupplier(${i})">Hapus</button></td>`; tbody.appendChild(tr) }) }
formSupplier.addEventListener('submit',e=>{ e.preventDefault(); const i=document.getElementById('supplierIndex').value; const data={id:document.getElementById('supplierId').value.trim(), name:document.getElementById('supplierName').value.trim(), hp:document.getElementById('supplierHP').value.trim(), ket:document.getElementById('supplierKeterangan').value.trim()}; if(!data.id||!data.name){alert('ID & Nama Perusahaan wajib'); return} if(i===''){ if(findIndexById(suppliers,data.id)!==-1){alert('ID supplier sudah ada'); return} suppliers.push(data) } else suppliers[i]=data; save(KEY.suppliers,suppliers); renderSuppliers(); resetSupplierForm(); populateProductSelects(); })
function editSupplier(i){ const s=suppliers[i]; document.getElementById('supplierIndex').value=i; document.getElementById('supplierId').value=s.id; document.getElementById('supplierName').value=s.name; document.getElementById('supplierHP').value=s.hp; document.getElementById('supplierKeterangan').value=s.ket }
function deleteSupplier(i){ if(confirm('Hapus supplier?')){ suppliers.splice(i,1); save(KEY.suppliers,suppliers); renderSuppliers(); populateProductSelects() }}
document.getElementById('resetSupplier').addEventListener('click',resetSupplierForm)
function resetSupplierForm(){ document.getElementById('supplierIndex').value=''; formSupplier.reset() }

// ======= CATEGORIES CRUD =======
const formCat=document.getElementById('formCat')
function renderCats(){ const tbody=document.querySelector('#tableCats tbody'); tbody.innerHTML=''; cats.forEach((c,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.id}</td><td>${c.name}</td><td><button class='btn btn-sm btn-warning me-1' onclick="editCat(${i})">Edit</button><button class='btn btn-sm btn-danger' onclick="deleteCat(${i})">Hapus</button></td>`; tbody.appendChild(tr) }) }
formCat.addEventListener('submit',e=>{ e.preventDefault(); const i=document.getElementById('catIndex').value; const data={id:document.getElementById('catId').value.trim(), name:document.getElementById('catName').value.trim()}; if(!data.id||!data.name){alert('ID & Nama wajib');return} if(i===''){ if(findIndexById(cats,data.id)!==-1){alert('ID kategori sudah ada'); return} cats.push(data)} else cats[i]=data; save(KEY.cats,cats); renderCats(); resetCatForm(); populateProductSelects() })
function editCat(i){ const c=cats[i]; document.getElementById('catIndex').value=i; document.getElementById('catId').value=c.id; document.getElementById('catName').value=c.name }
function deleteCat(i){ if(confirm('Hapus kategori?')){ cats.splice(i,1); save(KEY.cats,cats); renderCats(); populateProductSelects() }}
document.getElementById('resetCat').addEventListener('click',resetCatForm)
function resetCatForm(){ document.getElementById('catIndex').value=''; formCat.reset() }

// ======= ITEMS CRUD =======
const formItem=document.getElementById('formItem')
function renderItems(){ const tbody=document.querySelector('#tableItems tbody'); tbody.innerHTML=''; items.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.id}</td><td>${it.name}</td><td><button class='btn btn-sm btn-warning me-1' onclick="editItem(${i})">Edit</button><button class='btn btn-sm btn-danger' onclick="deleteItem(${i})">Hapus</button></td>`; tbody.appendChild(tr) }) }
formItem.addEventListener('submit',e=>{ e.preventDefault(); const i=document.getElementById('itemIndex').value; const data={id:document.getElementById('itemId').value.trim(), name:document.getElementById('itemName').value.trim()}; if(!data.id||!data.name){alert('ID & Nama wajib');return} if(i===''){ if(findIndexById(items,data.id)!==-1){alert('ID item sudah ada');return} items.push(data)} else items[i]=data; save(KEY.items,items); renderItems(); resetItemForm(); populateProductSelects() })
function editItem(i){ const it=items[i]; document.getElementById('itemIndex').value=i; document.getElementById('itemId').value=it.id; document.getElementById('itemName').value=it.name }
function deleteItem(i){ if(confirm('Hapus item?')){ items.splice(i,1); save(KEY.items,items); renderItems(); populateProductSelects() }}
document.getElementById('resetItem').addEventListener('click',resetItemForm)
function resetItemForm(){ document.getElementById('itemIndex').value=''; formItem.reset() }

// ======= PRODUCTS CRUD =======
const formProd=document.getElementById('formProduct')
function renderProducts(){ const tbody=document.querySelector('#tableProducts tbody'); tbody.innerHTML=''; prods.forEach((p,i)=>{ const sup = suppliers.find(s=>s.id==p.supplier)?.name || '-'; const cat = cats.find(c=>c.id==p.cat)?.name||'-'; const it = items.find(x=>x.id==p.item)?.name||'-'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.id}</td><td>${p.name}</td><td>${sup}</td><td>${cat}</td><td>${it}</td><td>${p.stock}</td><td>${formatRupiah(p.price)}</td><td><button class='btn btn-sm btn-warning me-1' onclick="editProd(${i})">Edit</button><button class='btn btn-sm btn-danger' onclick="deleteProd(${i})">Hapus</button></td>`; tbody.appendChild(tr) }) }
function populateProductSelects(){ const selProd = document.getElementById('selectProduct'); selProd.innerHTML='<option value="">--Pilih Produk--</option>'; prods.forEach(p=>{ selProd.insertAdjacentHTML('beforeend',`<option value="${p.id}">${p.name} (Stok: ${p.stock}) - Rp ${formatRupiah(p.price)}</option>`) })
 // product form selects
 const supSel=document.getElementById('prodSupplier'); supSel.innerHTML=''; suppliers.forEach(s=> supSel.insertAdjacentHTML('beforeend',`<option value="${s.id}">${s.name}</option>`))
 const catSel=document.getElementById('prodCat'); catSel.innerHTML=''; cats.forEach(c=> catSel.insertAdjacentHTML('beforeend',`<option value="${c.id}">${c.name}</option>`))
 const itemSel=document.getElementById('prodItem'); itemSel.innerHTML=''; items.forEach(it=> itemSel.insertAdjacentHTML('beforeend',`<option value="${it.id}">${it.name}</option>`))
}
formProd.addEventListener('submit',e=>{ e.preventDefault(); const i=document.getElementById('prodIndex').value; const data={id:document.getElementById('prodId').value.trim(), name:document.getElementById('prodName').value.trim(), supplier:document.getElementById('prodSupplier').value, cat:document.getElementById('prodCat').value, item:document.getElementById('prodItem').value, stock: Number(document.getElementById('prodStock').value)||0, price: Number(document.getElementById('prodPrice').value)||0}; if(!data.id||!data.name){alert('ID & Nama Produk wajib');return} if(i===''){ if(findIndexById(prods,data.id)!==-1){alert('ID produk sudah ada');return} prods.push(data)} else prods[i]=data; save(KEY.prods,prods); renderProducts(); resetProdForm(); populateProductSelects() })
function editProd(i){ const p=prods[i]; document.getElementById('prodIndex').value=i; document.getElementById('prodId').value=p.id; document.getElementById('prodName').value=p.name; document.getElementById('prodSupplier').value=p.supplier; document.getElementById('prodCat').value=p.cat; document.getElementById('prodItem').value=p.item; document.getElementById('prodStock').value=p.stock; document.getElementById('prodPrice').value=p.price }
function deleteProd(i){ if(confirm('Hapus produk?')){ prods.splice(i,1); save(KEY.prods,prods); renderProducts(); populateProductSelects() }}
document.getElementById('resetProd').addEventListener('click',resetProdForm)
function resetProdForm(){ document.getElementById('prodIndex').value=''; formProd.reset(); document.getElementById('prodStock').value=0; document.getElementById('prodPrice').value=0 }

// ======= TRANSACTIONS & CART =======
let cart = [] // {prodId, name, price, qty}
const transType = document.getElementById('transType'); const memberBlock=document.getElementById('memberBlock'); const umumBlock=document.getElementById('umumBlock');
transType.addEventListener('change',()=>{ if(transType.value==='member'){ memberBlock.style.display='block'; umumBlock.style.display='none' } else { memberBlock.style.display='none'; umumBlock.style.display='block' } })
function populateMemberSelect(){ const sel=document.getElementById('selectMember'); sel.innerHTML='<option value="">--Pilih--</option>'; users.forEach(u=> sel.insertAdjacentHTML('beforeend',`<option value="${u.id}">${u.name} [${u.id}]</option>`)) }
function populateProductSelect(){ const sel=document.getElementById('selectProduct'); sel.innerHTML='<option value="">--Pilih Produk--</option>'; prods.forEach(p=> sel.insertAdjacentHTML('beforeend',`<option value="${p.id}">${p.name} (Stok ${p.stock}) - Rp ${formatRupiah(p.price)}</option>`)) }

document.getElementById('addToCart').addEventListener('click',()=>{
  const pid = document.getElementById('selectProduct').value; const qty = Number(document.getElementById('cartQty').value)||1; if(!pid){alert('Pilih produk dulu'); return}
  const p = prods.find(x=>x.id==pid); if(!p){alert('Produk tidak ditemukan');return}
  if(qty>p.stock){alert('Jumlah melebihi stok'); return}
  const exists = cart.find(c=>c.prodId==pid)
  if(exists) exists.qty += qty; else cart.push({prodId:pid, name:p.name, price:p.price, qty})
  renderCart();
})

document.getElementById('discountToggle').addEventListener('change',(e)=>{ document.getElementById('discountBox').style.display = e.target.checked? 'block':'none' })
document.getElementById('payMethod').addEventListener('change',(e)=>{ const v=e.target.value; document.getElementById('tfBlock').style.display = v==='tf'? 'block':'none'; document.getElementById('kreditBlock').style.display = v==='kredit'? 'block':'none' })

function renderCart(){ const el=document.getElementById('cartList'); el.innerHTML=''; let subtotal=0; cart.forEach((c,i)=>{ const p = prods.find(x=>x.id==c.prodId); const row = document.createElement('div'); row.className='d-flex justify-content-between border p-2 mb-1 align-items-center'; row.innerHTML=`<div><strong>${c.name}</strong> <div class='small text-muted'>Rp ${formatRupiah(c.price)} x ${c.qty}</div></div><div><button class='btn btn-sm btn-danger me-1' onclick="removeCart(${i})">-</button><button class='btn btn-sm btn-secondary me-1' onclick="decCart(${i})">â€”</button><button class='btn btn-sm btn-success' onclick="incCart(${i})">+</button></div>`; el.appendChild(row); subtotal += c.price * c.qty })
  document.getElementById('subTotal').textContent = formatRupiah(subtotal)
  // calculate discount
  let diskRp = 0; if(document.getElementById('discountToggle').checked){ const t=document.getElementById('discountType').value; const v=Number(document.getElementById('discountValue').value)||0; if(t==='percent') diskRp = Math.round(subtotal * (v/100)); else diskRp = v }
  document.getElementById('diskonRp').textContent = formatRupiah(diskRp)
  const adminFee = Math.round(subtotal * 0.15)
  document.getElementById('adminFee').textContent = formatRupiah(adminFee)
  const total = Math.max(0, subtotal - diskRp + adminFee)
  document.getElementById('totalBayar').textContent = formatRupiah(total)
}

function removeCart(i){ cart.splice(i,1); renderCart() }
function decCart(i){ if(cart[i].qty>1) cart[i].qty--; else cart.splice(i,1); renderCart() }
function incCart(i){ const p = prods.find(x=>x.id==cart[i].prodId); if(cart[i].qty < p.stock) cart[i].qty++; else alert('Maks stok'); renderCart() }

// payment finish
document.getElementById('finishTrans').addEventListener('click',()=>{
  if(cart.length===0){alert('Keranjang kosong'); return}
  const tipe = transType.value; let pelanggan = '';
  if(tipe==='member'){ const mid = document.getElementById('selectMember').value; if(!mid){alert('Pilih member'); return} pelanggan = users.find(u=>u.id==mid)?.name || mid }
  else { const name = document.getElementById('umumName').value.trim(); if(!name){alert('Isi nama pelanggan umum'); return} pelanggan = name }
  // totals
  let subtotal = cart.reduce((s,c)=> s + c.price*c.qty,0)
  let diskRp = 0; if(document.getElementById('discountToggle').checked){ const t=document.getElementById('discountType').value; const v=Number(document.getElementById('discountValue').value)||0; if(t==='percent') diskRp = Math.round(subtotal*(v/100)); else diskRp = v }
  const adminFee = Math.round(subtotal * 0.15)
  const total = Math.max(0, subtotal - diskRp + adminFee)
  const dp = Number(document.getElementById('downPayment').value)||0
  const method = document.getElementById('payMethod').value
  if(dp > total){ alert('DP tidak boleh lebih besar dari total'); return }

  // handle methods
  let status = 'Belum Lunas'
  if(method==='cash'){
    if(dp >= total){ status='Lunas' }
    else { // kurang -> alihkan ke kredit automatically
      if(!confirm('Pembayaran cash kurang, ingin konversi ke kredit otomatis? Tekan OK untuk lanjut (akan buat entry kredit).')) return
      createCreditFlow(pelanggan, cart, subtotal, diskRp, adminFee, total, dp)
      return
    }
  } else if(method==='tf'){
    // require proof
    const proof = document.getElementById('tfProof').value.trim(); if(!proof){ if(!confirm('Anda tidak mengisi bukti transfer. Tetap simpan sebagai Pending?')) return }
    status = dp >= total ? 'Lunas' : 'Pending'
  } else if(method==='kredit'){
    // create kredit entry
    createCreditFlow(pelanggan, cart, subtotal, diskRp, adminFee, total, dp)
    return
  }

  // save transaction
  const id = 'TR' + Date.now()
  const t = {id, date: new Date().toISOString(), customer:pelanggan, items: cart, subtotal, diskRp, adminFee, total, dp, method, status}
  trans.push(t); save(KEY.trans, trans)
  // reduce stock
  cart.forEach(c=>{ const p = prods.find(x=>x.id==c.prodId); if(p) p.stock = Math.max(0, p.stock - c.qty) }); save(KEY.prods, prods)
  // reset
  cart=[]; renderCart(); renderProducts(); renderTrans(); populateProductSelect(); alert('Transaksi tersimpan')
})

function createCreditFlow(pelanggan, cartData, subtotal, diskRp, adminFee, total, dp){
  const tenor = Number(document.getElementById('tenor').value)||1
  const bungaPerbulan = 4.2/100
  const principal = total - dp
  const admin = adminFee
  // monthly payment simple interest on remaining per month (annuity not required) -> use annuity formula for monthly
  const r = bungaPerbulan
  const n = tenor
  // monthly payment using annuity formula
  const monthly = Math.round((principal * r) / (1 - Math.pow(1+r, -n)))
  const schedule = []
  for(let i=1;i<=n;i++){ schedule.push({month:i, amount:monthly, paid:0}) }
  const id = 'TR' + Date.now()
  const credit = {id, date:new Date().toISOString(), customer:pelanggan, items:cartData, subtotal, diskRp, adminFee, total, dp, principal, tenor, monthly, schedule, status:'Kredit'}
  credits.push(credit); save(KEY.credits, credits)
  // also save as transaction with status Kredit
  const t = {id, date:new Date().toISOString(), customer:pelanggan, items: cartData, subtotal, diskRp, adminFee, total, dp, method:'Kredit', status:'Kredit'}
  trans.push(t); save(KEY.trans, trans)
  // reduce stock
  cartData.forEach(c=>{ const p=prods.find(x=>x.id==c.prodId); if(p) p.stock = Math.max(0,p.stock - c.qty) }); save(KEY.prods, prods)
  cart=[]; renderCart(); renderProducts(); renderTrans(); populateProductSelect(); alert('Entry kredit tersimpan. Tenor: '+tenor+' bulan, angsuran per bulan: Rp '+formatRupiah(monthly))
}

function renderTrans(){ const tbody=document.querySelector('#tableTrans tbody'); tbody.innerHTML=''; trans.forEach((t,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.id}</td><td>${t.customer}</td><td>Rp ${formatRupiah(t.total)}</td><td>Rp ${formatRupiah(t.dp)}</td><td>${t.method}</td><td>${t.status}</td><td><button class='btn btn-sm btn-info' onclick="viewTrans(${i})">Lihat</button></td>`; tbody.appendChild(tr) }) }
function viewTrans(i){ const t=trans[i]; alert('Detail Transaksi:\nID: '+t.id+'\nPelanggan: '+t.customer+'\nTotal: Rp '+formatRupiah(t.total)+'\nStatus: '+t.status) }

// ======= REPORTS =======
function renderReports(){ const sumTotal = trans.reduce((s,t)=> s + (t.total||0),0); const totalCount = trans.length; const pending = trans.filter(t=> t.status==='Pending' || t.status==='Belum Lunas').length; const kred = credits.length
  const el=document.getElementById('reportSummary'); el.innerHTML=`<div class="row"><div class="col-md-3"><div class="p-3 bg-white rounded">Total Transaksi: <strong>${totalCount}</strong></div></div><div class="col-md-3"><div class="p-3 bg-white rounded">Total Omzet: <strong>Rp ${formatRupiah(sumTotal)}</strong></div></div><div class="col-md-3"><div class="p-3 bg-white rounded">Pending/Belum Lunas: <strong>${pending}</strong></div></div><div class="col-md-3"><div class="p-3 bg-white rounded">Credit Accounts: <strong>${kred}</strong></div></div></div>`
  const tbody = document.querySelector('#reportTrans tbody'); tbody.innerHTML=''; trans.forEach(t=>{ const prodNames = t.items.map(i=> i.name + ' x'+i.qty).join(', '); const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.id}</td><td>${new Date(t.date).toLocaleString()}</td><td>${t.customer}</td><td>${prodNames}</td><td>Rp ${formatRupiah(t.total)}</td><td>${t.method}</td><td>${t.status}</td>`; tbody.appendChild(tr) }) }

// ======= BOOTSTRAP ON LOAD =======
function init(){ renderUsers(); renderSuppliers(); renderCats(); renderItems(); renderProducts(); populateProductSelects(); populateMemberSelect(); renderTrans(); renderReports() }
init()

// Expose some functions for inline handlers
window.editUser = editUser; window.deleteUser = deleteUser; window.editSupplier = editSupplier; window.deleteSupplier = deleteSupplier; window.editCat = editCat; window.deleteCat = deleteCat; window.editItem = editItem; window.deleteItem = deleteItem; window.editProd = editProd; window.deleteProd = deleteProd; window.removeCart = removeCart; window.decCart = decCart; window.incCart = incCart; window.viewTrans = viewTrans;

</script>
</body>
</html>
